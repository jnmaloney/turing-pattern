<html>
    <link rel="stylesheet" href="style.css">
        
        <div style = "margin: 0px auto; width: 640px;">
            <canvas id="a" style="float:left" width="640" height="480"></canvas>
            <p class="legend right">
            <a onclick="setBroadside(); return false;" href="#">Preset A</a>
            </p>
             <p class="legend left">Reaction speed&nbsp;
            <a onclick="decAntenna(); return false;" href="#">-</a>
            </p>
            <p id="n" class="legend left fixedwidth"></p>
            <p class="legend left">
            <a onclick="incAntenna(); return false;" href="#">+</a>
            </p>
            <p class="clear"></p>
            <p class="legend right">
            <a onclick="setNearView(); return false;" href="#">Preset B</a>
            </p>
            <p class="legend left">Diffusion ratio&nbsp;
            <a onclick="decBlock(); return false;" href="#">-</a>
            </p>
            <p id="d" class="legend left fixedwidth"></p>
            <p class="legend left">
            <a onclick="incBlock(); return false;" href="#">+</a>
            </p>
            <p class="clear"></p>
            <p class="legend right">
            <a onclick="setEndfire(); return false;" href="#">Preset C</a>
            </p>
            <p class="legend left">Distortion&nbsp;
            <a onclick="decBeta(); return false;" href="#">-</a>
            </p>
            <p id="b" class="legend left fixedwidth"></p>
            <p class="legend left">
            <a onclick="incBeta(); return false;" href="#">+</a>
            </p>
            <p class="clear"></p>
            <p class="legend right">
            <a onclick="setFarView(); return false;" href="#">Preset D</a>
            </p>
        </div>
        
        <script>
            
            var width = 64;
            var height = 64;
            var blockSize = 4;
            
            var a_canvas = null;
            var a_context = null;
            
            var L = 64;
            var u = new Array(L*L);
            var v = new Array(L*L);
            var du = new Array(L*L);
            var dv = new Array(L*L);
            var beta = new Array(L*L);
            var b = 1.400;
            var a = 0.025;
            var r = 10000;
            var D1 = 0.25;
            var D2 = 0.0625;
            //var D1 = 1/4;
            //var D2 = D1/4;
            
            var dratio = 4;
            var speed = 3;
            var base_speed = 0.03125;
            var base_beta = 12.0;
            var u_max = 8;
            var v_max = 8;

            
            function start() {
                
                var requestAnimationFrame = window.requestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.msRequestAnimationFrame;
                
                a_canvas = document.getElementById("a");
                a_context = a_canvas.getContext("2d");
                a_context.fillRect(50, 25, 150, 100);
                
                a_canvas.onmousemove = mouseEffect;
                
                document.getElementById("n").innerHTML = speed;
                document.getElementById("d").innerHTML = "1:" + dratio;
                document.getElementById("b").innerHTML = base_beta;
                width = a_canvas.width / blockSize;
                height = a_canvas.height / blockSize;
                
                setBroadside();
                
                //
                c = 0;
                for (var i = 0; i < L; i++) {
                    for (var j = 0; j < L; j++) {
                        u[c] = 4.0;// + 0.1 * de(i, j) * de(j, i);//b + de(i, j);
                        v[c] = 4.0;// + 0.1 * de(i, j) * de(j, i);//1.0/b + 0.1 * de(i, j);
                        beta[c] = 12.0 + 1.05 * (Math.random() - 0.5);
                        ++c;
                    }
                }
                
                //
                requestAnimationFrame(frame);
            }
        
        
        function de(x, y) {
            var k1 = 0.25;
            var k2 = 0.02;
            return 0.21 * (Math.cos(k1 * x + k2 * y)) * Math.random() + 0.21 * (Math.cos(k1 * x - k2 * y)) * Math.random();
        }
        
        function mouseEffect(e) {
            return;
            c = 0;
            x = (e.pageX - a_canvas.offsetLeft)/blockSize;
            y = (e.pageY - a_canvas.offsetTop)/blockSize;
            for (var i = 0; i < L; i++) {
                for (var j = 0; j < L; j++) {
                    d2 = ((x-i)*(x-i) + (y-j)*(y-j));
                    //d = 6.0 / (d2*0.24 + 1);
                    kk = 1.0/64.0;
                    d = 0.50 * Math.cos(kk * d2);
                    beta[c] = base_beta + d;// + 3.5 * (Math.random() - 0.5);
                    ++c;
                }
            }
        }
        
        
        function react_f(a, b) {
            //return r * (a - a_u + a_u * a_u * a_v);
            return base_speed * (16.0 - a * b);
        }
        
        function react_g(a, b, d) {
            //return r * (b - a_u * a_u * a_v);
            return base_speed * (a * b - b - d);
        }

        
        function frame() {
            
            // Calculate
            var dt = 1.0;
            var dx = 1.0;
            var dx2 = dx*dx;
            var C1 = D1 / dx2; // = D1 / dx^2
            var C2 = D2 / dx2; // = d * D2 / dx^2
            var d = 1;
  
            
            c = 0;
            e = 1;
            w = L - 1;
            n = L * L - (L - 1) - 1;
            s = L;
            for (var i = 0; i < L; i++) {
                    for (var j = 0; j < L; j++) {
                        
                        n = (i == 0) ? (c - L + L*L) : (c - L);
                        s = (i == L-1) ? (c - L*L + L) : (c + L);
                        e = (j == L-1) ? (c-L + 1) : (c + 1);
                        w = (j == 0) ? (c+L - 1) : (c-1);
                        
                        du[c] = C1 * (-4*u[c] + u[n] + u[e] + u[s] + u[w]) + react_f(u[c], v[c]);
                        dv[c] = C2 * (-4*v[c] + v[n] + v[e] + v[s] + v[w]) + react_g(u[c], v[c], beta[c]);
                        //du[c] = C1 * (-2*u[c] + u[e] + u[w]) +  react_f(u[c], v[c]);
                        //dv[c] = C1 * (-2*v[c] + v[e] + v[w]) +  react_g(u[c], v[c], beta[c]);
                        ++c;
                        //n = (n + 1) % (L*L);
                        //e = (e + 1) % (L*L);
                        //s = (s + 1) % (L*L);
                        //w = (w + 1) % (L*L);
                    }
            }


            // Apply
            c = 0;
            for (var i = 0; i < L; i++) {
                for (var j = 0; j < L; j++) {
                    
                    u[c] += du[c] * dt;
                    v[c] += dv[c] * dt;
                    
                    if (u[c] > u_max) {u[c] = u_max;}
                    if (u[c] < 0) {u[c] = 0;}
                    if (v[c] > v_max) {v[c] = v_max;}
                    if (v[c] < 0) {v[c] = 0;}
                    
                    var A = v[c];
                    var scaleA = 1/6.0;
                    
                    var rstyle = A > 6 ?  255 :   200; //208;
                    var gstyle = A > 6 ? 251 :  46; //243;
                    var bstyle = A > 6 ? 64 : 131;//  3;
                    
                    var rstyle2 = A > 6 ?  200 :   20; //208;
                    var gstyle2 = A > 6 ? 46 :  5; //243;
                    var bstyle2 = A > 6 ? 131 : 13;//  3;
                    
                    var ratio = A * scaleA;
                    if (ratio > 1) ratio -= 1;
                    
                    var rfill = ratio * rstyle + (1.0 - ratio) * rstyle2;
                    var gfill = ratio * gstyle + (1.0 - ratio) * gstyle2;
                    var bfill = ratio * bstyle + (1.0 - ratio) * bstyle2;
                    
                    a_context.fillStyle = "rgba(" + parseInt(rfill) + "," + parseInt(gfill) + "," + parseInt(bfill) + ", 255)";
                    a_context.fillRect(i * blockSize + 1,
                                       j * blockSize + 1,
                                       blockSize,
                                       blockSize);
                                       
                    ++c;
                } // j
            } // i
            
            
            requestAnimationFrame(frame);
        }
        
        function setBroadside() {
            base_beta = 11.5;
            speed = 4;
            base_speed = 0.015 * speed;
            dratio = 4;
            D2 = D1 / dratio;
            
            //
            c = 0;
            for (var i = 0; i < L; i++) {
                for (var j = 0; j < L; j++) {
                    u[c] = base_beta;// + 0.1 * de(i, j) * de(j, i);//b + de(i, j);
                    v[c] = base_beta;// + 0.1 * de(i, j) * de(j, i);//1.0/b + 0.1 * de(i, j);
                    beta[c] = base_beta + 3.5 * (Math.random() - 0.5);
                    ++c;
                }
            }
            
            document.getElementById("n").innerHTML = speed;
            document.getElementById("d").innerHTML = "1:" + dratio;
            document.getElementById("b").innerHTML = base_beta;
        }
        
        function setEndfire() {
            base_beta = 12.5;
            speed = 4;
            base_speed = 0.015 * speed;
            dratio = 4;
            D2 = D1 / dratio;
            
            //
            c = 0;
            for (var i = 0; i < L; i++) {
                for (var j = 0; j < L; j++) {
                    u[c] = base_beta;// + 0.1 * de(i, j) * de(j, i);//b + de(i, j);
                    v[c] = base_beta;// + 0.1 * de(i, j) * de(j, i);//1.0/b + 0.1 * de(i, j);
                    beta[c] = base_beta + 3.5 * (Math.random() - 0.5);
                    ++c;
                }
            }
            
            document.getElementById("n").innerHTML = speed;
            document.getElementById("d").innerHTML = "1:" + dratio;
            document.getElementById("b").innerHTML = base_beta;
        }
        
        function setNearView() {
            base_beta = 12.0;
            speed = 4;
            base_speed = 0.015 * speed;
            dratio = 5;
            D2 = D1 / dratio;
            
            //
            c = 0;
            for (var i = 0; i < L; i++) {
                for (var j = 0; j < L; j++) {
                    u[c] = base_beta;// + 0.1 * de(i, j) * de(j, i);//b + de(i, j);
                    v[c] = base_beta;// + 0.1 * de(i, j) * de(j, i);//1.0/b + 0.1 * de(i, j);
                    beta[c] = base_beta + 3.5 * (Math.random() - 0.5);
                    ++c;
                }
            }
            
            document.getElementById("n").innerHTML = speed;
            document.getElementById("d").innerHTML = "1:" + dratio;
            document.getElementById("b").innerHTML = base_beta;
        }
        
        function setFarView() {
            base_beta = 12;
            speed = 8;
            base_speed = 0.015 * speed;
            dratio = 4;
            D2 = D1 / dratio;
            
            //
            c = 0;
            for (var i = 0; i < L; i++) {
                for (var j = 0; j < L; j++) {
                    u[c] = base_beta;// + 0.1 * de(i, j) * de(j, i);//b + de(i, j);
                    v[c] = base_beta;// + 0.1 * de(i, j) * de(j, i);//1.0/b + 0.1 * de(i, j);
                    beta[c] = base_beta + 3.0 * (Math.random() - 0.5);
                    ++c;
                }
            }
            
            document.getElementById("n").innerHTML = speed;
            document.getElementById("d").innerHTML = "1:" + dratio;
            document.getElementById("b").innerHTML = base_beta;
        }
        
        
        function incAntenna() {
            speed = (speed == 8) ? 8 : speed+1;
            document.getElementById("n").innerHTML = speed;
            base_speed = 0.005 * speed;
        }
        
        function decAntenna() {
            speed = (speed == 1) ? 1 : speed-1;
            document.getElementById("n").innerHTML = speed;
            base_speed = 0.005 * speed;
        }
        
        function decBlock() {
            
            dratio = (dratio == 1) ? 1 : dratio-1;
            document.getElementById("d").innerHTML = "1:" + dratio;
            D2 = D1 / dratio;
        }
        
        function incBlock() {
            
            dratio = (dratio == 8) ? 8 : dratio+1;
            document.getElementById("d").innerHTML = "1:" + dratio;
            D2 = D1 / dratio;
        }
        
        function decBeta() {
            
            base_beta = (base_beta <= 1) ? 1 : base_beta-0.5;
            document.getElementById("b").innerHTML = base_beta;
            
            //
            c = 0;
            for (var i = 0; i < L; i++) {
                for (var j = 0; j < L; j++) {
                    beta[c] = base_beta + 3.5 * (Math.random() - 0.5);
                    ++c;
                }
            }
        }
        
        function incBeta() {
            
            base_beta = (base_beta >= 20) ? 20 : base_beta+0.5;
            document.getElementById("b").innerHTML = base_beta;
            
            //
            c = 0;
            for (var i = 0; i < L; i++) {
                for (var j = 0; j < L; j++) {
                    beta[c] = base_beta + 3.5 * (Math.random() - 0.5);
                    ++c;
                }
            }
        }
        
        window.onload=start;
      
    </script>
</html>
